<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Print Lab - Student Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-gradient-start: #f0f4ff;
  --bg-gradient-end: #e8f0fe;
  --card-bg: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --accent: #8b5cf6;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --info: #3b82f6;
  --info-light: #dbeafe;
  --border: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
  min-height: 100vh;
  color: var(--text-primary);
  padding: 24px;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 24px;
  box-shadow: var(--shadow-md);
}

.brand-text h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.brand-text .subtitle {
  font-size: 14px;
  color: var(--text-secondary);
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: inherit;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-icon:hover {
  background: var(--bg-gradient-start);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--card-bg);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-gradient-start);
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.stat-card h3 {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.stat-card .value {
  font-size: 36px;
  font-weight: 700;
  color: var(--text-primary);
}

.stat-card.pending .value { color: var(--warning); }
.stat-card.printing .value { color: var(--info); }
.stat-card.completed .value { color: var(--success); }

/* Main Card */
.main-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 28px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.upload-section {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.file-info {
  font-size: 13px;
  color: var(--text-secondary);
}

.file-info strong {
  color: var(--primary);
  font-weight: 600;
}

/* Progress Bar */
.progress-container {
  height: 8px;
  background: var(--border);
  border-radius: 999px;
  overflow: hidden;
  margin: 16px 0;
  display: none;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  transition: width 0.3s ease;
  border-radius: 999px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border);
  padding-bottom: 0;
}

.tab {
  padding: 12px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s ease;
  font-family: inherit;
}

.tab:hover {
  color: var(--text-primary);
  background: var(--bg-gradient-start);
  border-radius: 8px 8px 0 0;
}

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid var(--border);
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

thead {
  background: var(--bg-gradient-start);
}

thead th {
  padding: 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

tbody td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

tbody tr:last-child td {
  border-bottom: none;
}

tbody tr:hover {
  background: var(--bg-gradient-start);
}

.file-name {
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.file-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: 700;
}

/* Status Pills */
.status-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.status-pending {
  background: var(--warning-light);
  color: var(--warning);
}

.status-printing {
  background: var(--info-light);
  color: var(--info);
}

.status-done {
  background: var(--success-light);
  color: var(--success);
}

.position-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
}

.btn-action {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.btn-action:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-muted);
}

.empty-state svg {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.empty-state p {
  font-size: 14px;
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--card-bg);
  padding: 16px 20px;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--warning); }
.toast.info { border-left: 4px solid var(--info); }

/* Responsive */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .card-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .upload-section {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.3s ease;
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo">3D</div>
      <div class="brand-text">
        <h1 id="welcomeTitle">Welcome</h1>
        <div class="subtitle" id="userEmail">Loading...</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-icon" id="refreshBtn" title="Refresh">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 0-2.4 6.01"/>
          <path d="M21 3v6h-6"/>
        </svg>
      </button>
      <button class="btn btn-secondary" id="logoutBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
        Logout
      </button>
    </div>
  </header>

  <div class="stats-grid fade-in">
    <div class="stat-card">
      <h3>Total Requests</h3>
      <div class="value" id="totalRequests">0</div>
    </div>
    <div class="stat-card pending">
      <h3>Pending</h3>
      <div class="value" id="pendingCount">0</div>
    </div>
    <div class="stat-card printing">
      <h3>Printing Now</h3>
      <div class="value" id="printingCount">0</div>
    </div>
    <div class="stat-card completed">
      <h3>Completed</h3>
      <div class="value" id="completedCount">0</div>
    </div>
  </div>

  <div class="main-card fade-in">
    <div class="card-header">
      <div class="upload-section">
        <button class="btn btn-primary" id="uploadBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Upload New Print
        </button>
        <div class="file-info">Accepted: <strong>.stl files</strong></div>
      </div>
    </div>

    <input type="file" id="fileInput" accept=".stl" style="display: none;">
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabActive">
        Active (Pending & Printing)
      </button>
      <button class="tab" id="tabCompleted">
        Completed
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>File Name</th>
            <th>Status</th>
            <th>Queue Position</th>
            <th>Uploaded</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="4">
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                <h3>No prints found</h3>
                <p>Upload your first 3D print to get started!</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://djjispvhfepnpugushfu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqamlzcHZoZmVwbnB1Z3VzaGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTg4NDIsImV4cCI6MjA3ODk5NDg0Mn0.odnTvtequxXuunM3AbEy1GUmWkGAh5_7FGNySvTvUzY';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentTab = 'active';

// DOM Elements
const welcomeTitle = document.getElementById('welcomeTitle');
const userEmail = document.getElementById('userEmail');
const totalRequestsEl = document.getElementById('totalRequests');
const pendingCountEl = document.getElementById('pendingCount');
const printingCountEl = document.getElementById('printingCount');
const completedCountEl = document.getElementById('completedCount');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');
const tableBody = document.getElementById('tableBody');
const tabActive = document.getElementById('tabActive');
const tabCompleted = document.getElementById('tabCompleted');
const refreshBtn = document.getElementById('refreshBtn');
const logoutBtn = document.getElementById('logoutBtn');

// Utility Functions
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : 
        type === 'error' ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>' :
        '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'}
    </svg>
    <span>${message}</span>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function formatDate(isoString) {
  if (!isoString) return 'â€”';
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getStatusPill(status) {
  const statusMap = {
    pending: '<span class="status-pill status-pending">Pending</span>',
    printing: '<span class="status-pill status-printing">Printing</span>',
    done: '<span class="status-pill status-done">Done</span>'
  };
  return statusMap[status] || statusMap.pending;
}

// Initialize User
async function initUser() {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      console.log('No session found, redirecting to login');
      window.location.href = '3dPrintingPortal.html';
      return;
    }

    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;
    console.log('Current user:', currentUser);

    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, email, is_admin')
      .eq('id', user.id)
      .single();

    console.log('Profile:', profile);

    // Redirect admins to admin dashboard
    if (profile && profile.is_admin === true) {
      console.log('User is admin, redirecting to admin dashboard');
      window.location.href = 'admin.html';
      return;
    }

    const userName = profile?.full_name || 'Student';
    const email = profile?.email || user.email;

    welcomeTitle.textContent = `Welcome, ${userName}`;
    userEmail.textContent = email;

    await loadDashboard();
  } catch (error) {
    console.error('Init error:', error);
    showToast('Failed to load user data', 'error');
  }
}

// Load Dashboard Data
async function loadDashboard() {
  if (!currentUser) {
    console.error('No current user');
    return;
  }

  try {
    console.log('Loading dashboard for user:', currentUser.id);
    
    const { data: queueData, error } = await supabase
      .from('queue')
      .select('id, user_id, file_name, status, created_at')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Queue fetch error:', error);
      throw error;
    }

    console.log('Queue data:', queueData);

    const userPrints = queueData ? queueData.filter(item => item.user_id === currentUser.id) : [];
    console.log('User prints:', userPrints);
    
    // Update stats
    totalRequestsEl.textContent = userPrints.length;
    pendingCountEl.textContent = userPrints.filter(p => p.status === 'pending').length;
    printingCountEl.textContent = userPrints.filter(p => p.status === 'printing').length;
    completedCountEl.textContent = userPrints.filter(p => p.status === 'done').length;

    // Filter based on current tab
    const filteredPrints = currentTab === 'active' 
      ? userPrints.filter(p => p.status === 'pending' || p.status === 'printing')
      : userPrints.filter(p => p.status === 'done');

    renderTable(filteredPrints, queueData || []);
  } catch (error) {
    console.error('Load error:', error);
    showToast('Failed to load dashboard data', 'error');
  }
}

// Render Table
function renderTable(prints, allQueue) {
  if (prints.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <h3>No ${currentTab === 'active' ? 'active' : 'completed'} prints</h3>
            <p>${currentTab === 'active' ? 'Upload your first 3D print to get started!' : 'Completed prints will appear here.'}</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  tableBody.innerHTML = prints.map(print => {
    const queuePosition = allQueue.findIndex(item => item.id === print.id) + 1;
    const fileName = escapeHtml(print.file_name);
    
    return `
      <tr class="fade-in">
        <td>
          <div class="file-name">
            <div class="file-icon">STL</div>
            ${fileName}
          </div>
        </td>
        <td>${getStatusPill(print.status)}</td>
        <td><div class="position-badge">${queuePosition}</div></td>
        <td style="color: var(--text-secondary); font-size: 14px;">${formatDate(print.created_at)}</td>
      </tr>
    `;
  }).join('');
}

// Upload File
async function uploadFile(file) {
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.stl')) {
    showToast('Please upload an STL file', 'error');
    return;
  }

  try {
    console.log('Starting upload for:', file.name);
    progressContainer.style.display = 'block';
    progressFill.style.width = '20%';

    const filePath = `${currentUser.id}/${Date.now()}_${file.name}`;
    console.log('Upload path:', filePath);
    
    const { error: uploadError } = await supabase.storage
      .from('stl-uploads')
      .upload(filePath, file, { cacheControl: '3600', upsert: false });

    if (uploadError) {
      console.error('Upload error:', uploadError);
      throw uploadError;
    }

    progressFill.style.width = '60%';

    const { error: dbError } = await supabase
      .from('queue')
      .insert([{
        user_id: currentUser.id,
        file_name: file.name,
        status: 'pending'
      }]);

    if (dbError) {
      console.error('DB insert error:', dbError);
      throw dbError;
    }

    progressFill.style.width = '100%';
    showToast('File uploaded successfully!', 'success');
    
    setTimeout(() => {
      progressContainer.style.display = 'none';
      progressFill.style.width = '0%';
    }, 500);

    await loadDashboard();
    fileInput.value = '';
  } catch (error) {
    console.error('Upload error:', error);
    showToast('Upload failed: ' + error.message, 'error');
    progressContainer.style.display = 'none';
    progressFill.style.width = '0%';
  }
}

// Download File
async function downloadFile(userId, fileName) {
  try {
    console.log('Downloading:', userId, fileName);
    
    // Try to find the file with timestamp prefix
    const { data: files, error: listError } = await supabase.storage
      .from('stl-uploads')
      .list(userId);

    if (listError) throw listError;

    // Find the file that ends with the correct filename
    const matchingFile = files.find(f => f.name.endsWith(fileName));
    const fullPath = matchingFile ? `${userId}/${matchingFile.name}` : `${userId}/${fileName}`;
    
    console.log('Download path:', fullPath);

    const { data, error } = await supabase.storage
      .from('stl-uploads')
      .download(fullPath);

    if (error) throw error;

    const url = URL.createObjectURL(data);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showToast('Download started', 'success');
  } catch (error) {
    console.error('Download error:', error);
    showToast('Download failed: ' + error.message, 'error');
  }
}

// Event Listeners
uploadBtn.addEventListener('click', () => {
  console.log('Upload button clicked');
  fileInput.click();
});

fileInput.addEventListener('change', (e) => {
  console.log('File selected:', e.target.files[0]);
  if (e.target.files[0]) uploadFile(e.target.files[0]);
});

tabActive.addEventListener('click', () => {
  console.log('Active tab clicked');
  currentTab = 'active';
  tabActive.classList.add('active');
  tabCompleted.classList.remove('active');
  loadDashboard();
});

tabCompleted.addEventListener('click', () => {
  console.log('Completed tab clicked');
  currentTab = 'completed';
  tabCompleted.classList.add('active');
  tabActive.classList.remove('active');
  loadDashboard();
});

refreshBtn.addEventListener('click', async () => {
  console.log('Refresh button clicked');
  refreshBtn.style.transform = 'rotate(360deg)';
  refreshBtn.style.transition = 'transform 0.5s ease';
  await loadDashboard();
  setTimeout(() => {
    refreshBtn.style.transform = '';
  }, 500);
  showToast('Dashboard refreshed', 'info');
});

logoutBtn.addEventListener('click', async () => {
  console.log('Logout button clicked');
  await supabase.auth.signOut();
  window.location.href = '3dPrintingPortal.html';
});

// Initialize
console.log('Initializing dashboard...');
initUser();
</script>
</body>
</html>
