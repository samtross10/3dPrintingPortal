<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Print Lab - Login</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-gradient-start: #f0f4ff;
  --bg-gradient-end: #e8f0fe;
  --card-bg: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --accent: #8b5cf6;
  --success: #10b981;
  --error: #ef4444;
  --border: #e2e8f0;
  --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  color: var(--text-primary);
}

.login-container {
  width: 100%;
  max-width: 440px;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.logo-section {
  text-align: center;
  margin-bottom: 32px;
}

.logo {
  width: 80px;
  height: 80px;
  margin: 0 auto 16px;
  border-radius: 20px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 36px;
  box-shadow: var(--shadow-lg);
}

.logo-section h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.logo-section p {
  color: var(--text-secondary);
  font-size: 15px;
}

.card {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 40px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 32px;
  background: var(--bg-gradient-start);
  padding: 4px;
  border-radius: 12px;
}

.tab {
  flex: 1;
  padding: 12px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.tab.active {
  background: white;
  color: var(--primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.form-group {
  margin-bottom: 24px;
}

.form-group label {
  display: block;
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.form-group input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.2s ease;
  background: white;
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-group input::placeholder {
  color: var(--text-secondary);
  opacity: 0.6;
}

.btn {
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.alert {
  padding: 14px 16px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 14px;
  font-weight: 500;
  display: none;
}

.alert.show {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-success {
  background: #d1fae5;
  color: var(--success);
  border: 1px solid var(--success);
}

.alert-error {
  background: #fee2e2;
  color: var(--error);
  border: 1px solid var(--error);
}

.divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 24px 0;
  color: var(--text-secondary);
  font-size: 13px;
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid var(--border);
}

.divider span {
  padding: 0 16px;
}

.magic-link-section {
  display: none;
}

.magic-link-section.show {
  display: block;
}

.info-box {
  background: var(--bg-gradient-start);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  margin-top: 20px;
  font-size: 14px;
  color: var(--text-secondary);
}

.info-box strong {
  color: var(--text-primary);
}

@media (max-width: 480px) {
  .card {
    padding: 28px 24px;
  }
  
  .logo-section h1 {
    font-size: 24px;
  }
}
</style>
</head>
<body>
<div class="login-container">
  <div class="logo-section">
    <div class="logo">3D</div>
    <h1>3D Print Lab</h1>
    <p>Student printing portal</p>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" id="loginTab">Login</button>
      <button class="tab" id="signupTab">Sign Up</button>
    </div>

    <div id="alertBox" class="alert"></div>

    <!-- Login Form -->
    <form id="loginForm">
      <div class="form-group">
        <label for="loginEmail">Email Address</label>
        <input 
          type="email" 
          id="loginEmail" 
          placeholder="your.email@school.edu" 
          required
        >
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input 
          type="password" 
          id="loginPassword" 
          placeholder="Enter your password" 
          required
        >
      </div>
      <button type="submit" class="btn btn-primary" id="loginBtn">
        <span id="loginBtnText">Login</span>
      </button>
    </form>

    <!-- Signup Form -->
    <form id="signupForm" style="display: none;">
      <div class="form-group">
        <label for="signupName">Full Name</label>
        <input 
          type="text" 
          id="signupName" 
          placeholder="John Doe" 
          required
        >
      </div>
      <div class="form-group">
        <label for="signupEmail">Email Address</label>
        <input 
          type="email" 
          id="signupEmail" 
          placeholder="your.email@school.edu" 
          required
        >
      </div>
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <input 
          type="password" 
          id="signupPassword" 
          placeholder="At least 6 characters" 
          required
          minlength="6"
        >
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input 
          type="password" 
          id="confirmPassword" 
          placeholder="Re-enter your password" 
          required
          minlength="6"
        >
      </div>
      <button type="submit" class="btn btn-primary" id="signupBtn">
        <span id="signupBtnText">Create Account</span>
      </button>
    </form>

    <div class="divider">
      <span>OR</span>
    </div>

    <button class="btn btn-primary" id="magicLinkBtn" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
      Send Magic Link
    </button>

    <div id="magicLinkSection" class="magic-link-section">
      <div class="info-box">
        <strong>âœ¨ Magic link sent!</strong><br>
        Check your email for a secure login link. Click it to access your dashboard instantly.
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://djjispvhfepnpugushfu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqamlzcHZoZmVwbnB1Z3VzaGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTg4NDIsImV4cCI6MjA3ODk5NDg0Mn0.odnTvtequxXuunM3AbEy1GUmWkGAh5_7FGNySvTvUzY';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM Elements
const loginTab = document.getElementById('loginTab');
const signupTab = document.getElementById('signupTab');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const alertBox = document.getElementById('alertBox');
const magicLinkBtn = document.getElementById('magicLinkBtn');
const magicLinkSection = document.getElementById('magicLinkSection');
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const loginBtnText = document.getElementById('loginBtnText');
const signupBtnText = document.getElementById('signupBtnText');

// Check if already logged in
async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    window.location.href = 'index.html'; // Redirect to dashboard
  }
}

// Alert Functions
function showAlert(message, type) {
  alertBox.textContent = message;
  alertBox.className = `alert alert-${type} show`;
  setTimeout(() => {
    alertBox.classList.remove('show');
  }, 5000);
}

function setLoading(button, textElement, isLoading) {
  button.disabled = isLoading;
  if (isLoading) {
    textElement.innerHTML = '<div class="spinner"></div>';
  } else {
    textElement.textContent = button.id === 'loginBtn' ? 'Login' : 'Create Account';
  }
}

// Tab Switching
loginTab.addEventListener('click', () => {
  loginTab.classList.add('active');
  signupTab.classList.remove('active');
  loginForm.style.display = 'block';
  signupForm.style.display = 'none';
  magicLinkSection.classList.remove('show');
  alertBox.classList.remove('show');
});

signupTab.addEventListener('click', () => {
  signupTab.classList.add('active');
  loginTab.classList.remove('active');
  signupForm.style.display = 'block';
  loginForm.style.display = 'none';
  magicLinkSection.classList.remove('show');
  alertBox.classList.remove('show');
});

// Login Handler
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;

  setLoading(loginBtn, loginBtnText, true);

  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) throw error;

    showAlert('Login successful! Redirecting...', 'success');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1000);
  } catch (error) {
    console.error('Login error:', error);
    showAlert(error.message || 'Login failed. Please check your credentials.', 'error');
    setLoading(loginBtn, loginBtnText, false);
  }
});

// Signup Handler
signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('signupName').value;
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  if (password !== confirmPassword) {
    showAlert('Passwords do not match!', 'error');
    return;
  }

  if (password.length < 6) {
    showAlert('Password must be at least 6 characters long.', 'error');
    return;
  }

  setLoading(signupBtn, signupBtnText, true);

  try {
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: name
        },
        emailRedirectTo: window.location.origin + '/index.html'
      }
    });

    if (authError) throw authError;

    // Create profile entry
    if (authData.user) {
      const { error: profileError } = await supabase
        .from('profiles')
        .insert([
          {
            id: authData.user.id,
            full_name: name,
            email: email
          }
        ]);

      if (profileError && profileError.code !== '23505') { // Ignore duplicate key errors
        console.error('Profile creation error:', profileError);
      }
    }

    showAlert('Account created successfully! Logging you in...', 'success');
    
    // Auto redirect to dashboard after signup
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1000);
  } catch (error) {
    console.error('Signup error:', error);
    showAlert(error.message || 'Signup failed. Please try again.', 'error');
  } finally {
    setLoading(signupBtn, signupBtnText, false);
  }
});

// Magic Link Handler
magicLinkBtn.addEventListener('click', async () => {
  const emailInput = loginTab.classList.contains('active') 
    ? document.getElementById('loginEmail')
    : document.getElementById('signupEmail');
  
  const email = emailInput.value;

  if (!email) {
    showAlert('Please enter your email address first.', 'error');
    emailInput.focus();
    return;
  }

  magicLinkBtn.disabled = true;
  magicLinkBtn.textContent = 'Sending...';

  try {
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: window.location.origin + '/index.html'
      }
    });

    if (error) throw error;

    magicLinkSection.classList.add('show');
    showAlert('Magic link sent! Check your email.', 'success');
  } catch (error) {
    console.error('Magic link error:', error);
    showAlert(error.message || 'Failed to send magic link.', 'error');
  } finally {
    magicLinkBtn.disabled = false;
    magicLinkBtn.textContent = 'Send Magic Link';
  }
});

// Initialize
checkSession();
</script>
</body>
</html>
