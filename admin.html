<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Print Lab - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-gradient-start: #f0f4ff;
  --bg-gradient-end: #e8f0fe;
  --card-bg: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --accent: #8b5cf6;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --info: #3b82f6;
  --info-light: #dbeafe;
  --border: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
  min-height: 100vh;
  color: var(--text-primary);
  padding: 24px;
  line-height: 1.6;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--danger), var(--warning));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 24px;
  box-shadow: var(--shadow-md);
}

.brand-text h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.admin-badge {
  display: inline-block;
  padding: 4px 12px;
  background: linear-gradient(135deg, var(--danger), var(--warning));
  color: white;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.brand-text .subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: inherit;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-icon:hover {
  background: var(--bg-gradient-start);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--card-bg);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-gradient-start);
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.stat-card h3 {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

.stat-card .value {
  font-size: 36px;
  font-weight: 700;
  color: var(--text-primary);
}

.stat-card.total .value { color: var(--primary); }
.stat-card.pending .value { color: var(--warning); }
.stat-card.printing .value { color: var(--info); }
.stat-card.completed .value { color: var(--success); }

/* Main Card */
.main-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 28px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid var(--border);
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 900px;
}

thead {
  background: var(--bg-gradient-start);
}

thead th {
  padding: 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

tbody td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

tbody tr:last-child td {
  border-bottom: none;
}

tbody tr:hover {
  background: var(--bg-gradient-start);
}

.file-name {
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.file-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: 700;
}

.user-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.user-name {
  font-weight: 600;
  color: var(--text-primary);
}

.user-email {
  font-size: 12px;
  color: var(--text-secondary);
}

/* Status Pills */
.status-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.status-pending {
  background: var(--warning-light);
  color: var(--warning);
}

.status-printing {
  background: var(--info-light);
  color: var(--info);
}

.status-done {
  background: var(--success-light);
  color: var(--success);
}

.position-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-action {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: white;
  color: var(--text-primary);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.btn-action:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.btn-action.download:hover {
  background: var(--info);
  color: white;
  border-color: var(--info);
}

.btn-action.delete:hover {
  background: var(--danger);
  color: white;
  border-color: var(--danger);
}

/* Status Selector */
.status-select {
  padding: 6px 12px;
  border-radius: 6px;
  border: 2px solid var(--border);
  background: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s ease;
}

.status-select:hover {
  border-color: var(--primary);
}

.status-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-muted);
}

.empty-state svg {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.empty-state p {
  font-size: 14px;
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--card-bg);
  padding: 16px 20px;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  animation: slideIn 0.3s ease;
  max-width: 400px;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--info); }

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}

.modal.show {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 32px;
  max-width: 500px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  margin-bottom: 20px;
}

.modal-header h2 {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.modal-header p {
  font-size: 14px;
  color: var(--text-secondary);
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.btn-cancel {
  flex: 1;
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: var(--text-primary);
}

.btn-confirm {
  flex: 1;
  background: var(--danger);
  color: white;
}

.btn-confirm:hover {
  background: #dc2626;
}

/* Responsive */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .card-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .btn-action {
    width: 100%;
  }
}

/* Animations */
.fade-in {
  animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo">⚡</div>
      <div class="brand-text">
        <h1>
          Admin Dashboard 
          <span class="admin-badge">Admin</span>
        </h1>
        <div class="subtitle" id="adminEmail">Loading...</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" id="studentViewBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
          <polyline points="10 17 15 12 10 7"/>
          <line x1="15" y1="12" x2="3" y2="12"/>
        </svg>
        Student View
      </button>
      <button class="btn-icon" id="refreshBtn" title="Refresh">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 0-2.4 6.01"/>
          <path d="M21 3v6h-6"/>
        </svg>
      </button>
      <button class="btn btn-secondary" id="logoutBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
        Logout
      </button>
    </div>
  </header>

  <div class="stats-grid fade-in">
    <div class="stat-card total">
      <h3>Total Queue</h3>
      <div class="value" id="totalQueue">0</div>
    </div>
    <div class="stat-card pending">
      <h3>Pending</h3>
      <div class="value" id="pendingCount">0</div>
    </div>
    <div class="stat-card printing">
      <h3>Printing Now</h3>
      <div class="value" id="printingCount">0</div>
    </div>
    <div class="stat-card completed">
      <h3>Completed</h3>
      <div class="value" id="completedCount">0</div>
    </div>
  </div>

  <div class="main-card fade-in">
    <div class="card-header">
      <h2 class="card-title">Print Queue Management</h2>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Position</th>
            <th>File Name</th>
            <th>Student</th>
            <th>Status</th>
            <th>Uploaded</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                <h3>No prints in queue</h3>
                <p>The print queue is empty.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Delete Print Job?</h2>
      <p>Are you sure you want to delete "<strong id="deleteFileName"></strong>"? This action cannot be undone.</p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel" id="cancelDeleteBtn">Cancel</button>
      <button class="btn btn-confirm" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://djjispvhfepnpugushfu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqamlzcHZoZmVwbnB1Z3VzaGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTg4NDIsImV4cCI6MjA3ODk5NDg0Mn0.odnTvtequxXuunM3AbEy1GUmWkGAh5_7FGNySvTvUzY';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let deleteItemId = null;

// DOM Elements
const adminEmail = document.getElementById('adminEmail');
const totalQueueEl = document.getElementById('totalQueue');
const pendingCountEl = document.getElementById('pendingCount');
const printingCountEl = document.getElementById('printingCount');
const completedCountEl = document.getElementById('completedCount');
const tableBody = document.getElementById('tableBody');
const refreshBtn = document.getElementById('refreshBtn');
const logoutBtn = document.getElementById('logoutBtn');
const studentViewBtn = document.getElementById('studentViewBtn');
const deleteModal = document.getElementById('deleteModal');
const deleteFileName = document.getElementById('deleteFileName');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

// Utility Functions
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : 
        type === 'error' ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>' :
        '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'}
    </svg>
    <span>${message}</span>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function formatDate(isoString) {
  if (!isoString) return '—';
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getStatusPill(status) {
  const statusMap = {
    pending: '<span class="status-pill status-pending">Pending</span>',
    printing: '<span class="status-pill status-printing">Printing</span>',
    done: '<span class="status-pill status-done">Done</span>'
  };
  return statusMap[status] || statusMap.pending;
}

// Initialize User and Check Admin
async function initUser() {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      console.log('No session found, redirecting to login');
      window.location.href = '3dPrintingPortal.html';
      return;
    }

    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;
    console.log('Current user:', currentUser);

    // Check if user is admin
    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, email, is_admin')
      .eq('id', user.id)
      .single();

    console.log('Profile:', profile);

    if (!profile || !profile.is_admin) {
      showToast('Access denied. Admin privileges required.', 'error');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
      return;
    }

    const email = profile?.email || user.email;
    adminEmail.textContent = email;

    await loadDashboard();
  } catch (error) {
    console.error('Init error:', error);
    showToast('Failed to load admin dashboard', 'error');
  }
}

// Load Dashboard Data
async function loadDashboard() {
  if (!currentUser) return;

  try {
    console.log('Loading admin dashboard...');
    
    // Fetch all queue items with user profiles
    const { data: queueData, error: queueError } = await supabase
      .from('queue')
      .select(`
        id,
        user_id,
        file_name,
        status,
        created_at,
        profiles:user_id (
          full_name,
          email
        )
      `)
      .order('created_at', { ascending: true });

    if (queueError) {
      console.error('Queue fetch error:', queueError);
      throw queueError;
    }

    console.log('Queue data:', queueData);

    const allPrints = queueData || [];
    
    // Update stats
    totalQueueEl.textContent = allPrints.length;
    pendingCountEl.textContent = allPrints.filter(p => p.status === 'pending').length;
    printingCountEl.textContent = allPrints.filter(p => p.status === 'printing').length;
    completedCountEl.textContent = allPrints.filter(p => p.status === 'done').length;

    renderTable(allPrints);
  } catch (error) {
    console.error('Load error:', error);
    showToast('Failed to load dashboard data', 'error');
  }
}

// Render Table
function renderTable(prints) {
  if (prints.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <h3>No prints in queue</h3>
            <p>The print queue is empty.</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  tableBody.innerHTML = prints.map((print, index) => {
    const fileName = escapeHtml(print.file_name);
    const userProfile = print.profiles;
    const userName = userProfile?.full_name || 'Unknown User';
    const userEmail = userProfile?.email || '';
    
    return `
      <tr class="fade-in">
        <td><div class="position-badge">${index + 1}</div></td>
        <td>
          <div class="file-name">
            <div class="file-icon">STL</div>
            ${fileName}
          </div>
        </td>
        <td>
          <div class="user-info">
            <div class="user-name">${escapeHtml(userName)}</div>
            <div class="user-email">${escapeHtml(userEmail)}</div>
          </div>
        </td>
        <td>
          <select class="status-select" data-id="${print.id}" data-current="${print.status}">
            <option value="pending" ${print.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="printing" ${print.status === 'printing' ? 'selected' : ''}>Printing</option>
            <option value="done" ${print.status === 'done' ? 'selected' : ''}>Done</option>
          </select>
        </td>
        <td style="color: var(--text-secondary); font-size: 14px;">${formatDate(print.created_at)}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-action download" data-user-id="${print.user_id}" data-file-name="${encodeURIComponent(print.file_name)}">
              Download
            </button>
            <button class="btn-action delete" data-id="${print.id}" data-file-name="${fileName}">
              Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  // Add event listeners
  attachEventListeners();
}

// Attach Event Listeners to Dynamic Elements
function attachEventListeners() {
  // Status change handlers
  document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async function() {
      const id = this.getAttribute('data-id');
      const newStatus = this.value;
      const oldStatus = this.getAttribute('data-current');
      
      try {
        const { error } = await supabase
          .from('queue')
          .update({ status: newStatus })
          .eq('id', id);

        if (error) throw error;

        this.setAttribute('data-current', newStatus);
        showToast(`Status updated to ${newStatus}`, 'success');
        await loadDashboard();
      } catch (error) {
        console.error('Status update error:', error);
        showToast('Failed to update status', 'error');
        this.value = oldStatus;
      }
    });
  });

  // Download button handlers
  document.querySelectorAll('.btn-action.download').forEach(btn => {
    btn.addEventListener('click', function() {
      const userId = this.getAttribute('data-user-id');
      const fileName = decodeURIComponent(this.getAttribute('data-file-name'));
      downloadFile(userId, fileName);
    });
  });

  // Delete button handlers
  document.querySelectorAll('.btn-action.delete').forEach(btn => {
    btn.addEventListener('click', function() {
      deleteItemId = this.getAttribute('data-id');
      const fileName = this.getAttribute('data-file-name');
      deleteFileName.textContent = fileName;
      deleteModal.classList.add('show');
    });
  });
}

// Download File
async function downloadFile(userId, fileName) {
  try {
    console.log('Downloading:', userId, fileName);
    
    // Try to find the file with timestamp prefix
    const { data: files, error: listError } = await supabase.storage
      .from('stl-uploads')
      .list(userId);

    if (listError) throw listError;

    // Find the file that ends with the correct filename
    const matchingFile = files.find(f => f.name.endsWith(fileName));
    const fullPath = matchingFile ? `${userId}/${matchingFile.name}` : `${userId}/${fileName}`;
    
    console.log('Download path:', fullPath);

    const { data, error } = await supabase.storage
      .from('stl-uploads')
      .download(fullPath);

    if (error) throw error;

    const url = URL.createObjectURL(data);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showToast('Download started', 'success');
  } catch (error) {
    console.error('Download error:', error);
    showToast('Download failed: ' + error.message, 'error');
  }
}

// Delete Print Job
async function deletePrintJob() {
  if (!deleteItemId) return;

  try {
    const { error } = await supabase
      .from('queue')
      .delete()
      .eq('id', deleteItemId);

    if (error) throw error;

    showToast('Print job deleted successfully', 'success');
    deleteModal.classList.remove('show');
    deleteItemId = null;
    await loadDashboard();
  } catch (error) {
    console.error('Delete error:', error);
    showToast('Failed to delete print job', 'error');
  }
}

// Event Listeners
refreshBtn.addEventListener('click', async () => {
  console.log('Refresh button clicked');
  refreshBtn.style.transform = 'rotate(360deg)';
  refreshBtn.style.transition = 'transform 0.5s ease';
  await loadDashboard();
  setTimeout(() => {
    refreshBtn.style.transform = '';
  }, 500);
  showToast('Dashboard refreshed', 'info');
});

logoutBtn.addEventListener('click', async () => {
  console.log('Logout button clicked');
  await supabase.auth.signOut();
  window.location.href = '3dPrintingPortal.html';
});

studentViewBtn.addEventListener('click', () => {
  window.location.href = 'index.html';
});

cancelDeleteBtn.addEventListener('click', () => {
  deleteModal.classList.remove('show');
  deleteItemId = null;
});

confirmDeleteBtn.addEventListener('click', deletePrintJob);

// Close modal on outside click
deleteModal.addEventListener('click', (e) => {
  if (e.target === deleteModal) {
    deleteModal.classList.remove('show');
    deleteItemId = null;
  }
});

// Initialize
console.log('Initializing admin dashboard...');
initUser();
</script>
</body>
</html>
